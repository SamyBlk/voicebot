<!DOCTYPE html>
<html>
<head>
  <title>Voicebot CTI</title>
</head>
<body>
  <h2>Voicebot connecté</h2>
  <script>
    console.log("Chargement softphone...");
    // ⚠️ sforce.opencti n’est disponible QUE SI on est dans l’iframe Salesforce CTI
    function tryInit() {
      if (typeof sforce === 'undefined') {
        console.warn("sforce non disponible (encore)");
        setTimeout(tryInit, 1000); // Retente après 1 seconde
        return;
      }

      console.log("✅ sforce détecté");
      sforce.opencti.notifyInitializationComplete({
        callback: function(result) {
          if (result.success) {
            console.log("CTI initialisé");
          } else {
            console.error("Erreur init:", result.errors);
          }
        }
      });

      window.addEventListener("message", function(event) {
        const data = event.data;
        if (data.type === "transcription") {
          sforce.opencti.saveLog({
            value: {
              entityApiName: "Task",
              Subject: "Voicebot Transcript",
              Description: data.text,
              Status: "Completed",
              Priority: "Normal"
            },
            callback: function(response) {
              if (response.success) {
                console.log("✅ Log enregistré", response.returnValue);
              } else {
                console.error("❌ Échec saveLog", response.errors);
              }
            }
          });
        }
      });
    }

    tryInit();
  </script>
</body>
</html>
